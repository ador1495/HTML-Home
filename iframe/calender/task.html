<style>
	body {
		margin: 16px;
		font-family: Arial, Helvetica, sans-serif;
		background: #121212;
		color: #e0e0e0;
		background-color: #141414;
	}
	button, input, select, textarea {
		background-color: #121212;
		color: #eee;
		border: none;
		padding: 4px 6px;
		font-size: 14px;
	}
	.progress-container {
		margin-top: 16px;
		position: relative;
		min-width: 200px;
		height: 12px;
		background: #222222;
		border-radius: 5px;
	}
	.progress {
		width: 0%;
		height: 100%;
		background-color: #555;
		border-radius: 5px;
		cursor: pointer;
	}
	markrange {
		position: absolute;
		top: 8px;
		width: 100%;
		height: 12px;
		background: #ccc;
	}
	marks {
		position: absolute;
	}
	point {
		display: flex;
		flex-direction: column;
		position: absolute;
	}
	marks line {
		width: 1px;
		min-height: 32px;
		background: #bbb;
		border: 1px solid black;
	}
	marks div {
		display: flex;
		flex-direction: column;
		border: 1px solid #333;
		padding: 5px;
		transform: translateX(-50%);
		text-align: center;
	}
	endpoint {
		display: flex;
		flex-direction: column;
		position: absolute;
		bottom: -32px;
		right: 0%;
		transform: translateX(100%);
	}
	#mg {
		position: absolute;
		top: -8px;
	}
	left {
		display: flex;
		flex-direction: column;
		width: 100%;
		height: 100%;
	}
	t {
		display: flex;
		margin-top: 76px;
		gap: 16px;
		height: 200px;
		width: 950px;
		max-width: 950px;
		overflow: auto;
		scrollbar-width: none;
	}
	t div {
		border: 1px solid gray;
		display: flex;
		flex-direction: column;
		width: 135px;
		padding: 2px;
		gap: 4px;
		text-align: center;
	}
	t div h {
		margin-bottom: 6px;
		white-space: nowrap;
		overflow: hidden;
	}
	.hide {
		display: none;
	}
	.show {
		display: flex;
	}
	.ep {
		z-index: 100;
		background: #111;
	}
	.task {
		width: 50px;
		height: 50px;
		background-size: cover;
		background-position: center;
		color: transparent;
	}
	point div label {
		height: 50px;
		overflow: auto;
		scrollbar-width: none;
	}
</style>

<left>
	<label id="weather"></label>
	<div class="progress-container">
		<div id="progress" class="progress"></div>
		<div id="mg">
			<!-- <marks class="" style="left: 776px; width: 100px"> -->
				<!-- <markrange class="hide"></markrange> -->
				<!-- <point> -->
					<!-- <line></line> -->
					<!-- <div> -->
						<!-- <button>20:15</button> -->
						<!-- <label contenteditable="true">Esha</label> -->
					<!-- </div> -->
				<!-- </point> -->
				<!-- <endpoint class="hide"> -->
					<!-- <div class="ep">20:45</div> -->
					<!-- <line></line> -->
				<!-- </endpoint> -->
			<!-- </marks> -->
		</div>
	</div>
</left>

<script>
	let sd = [];
	for (let i = 0; i < 366; i++) {sd.push([])}
	const timeProgress = document.getElementById("progress"), timeContainer = document.querySelector(".progress-container"), rect = timeContainer.getBoundingClientRect(), now = new Date(); const dd = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24)), markgroup = document.getElementById("mg"); let de = 0, ep = false;
	//localStorage.removeItem('marks');
	let newMark = false, drag = false;
	//document.querySelectorAll('#mg point div label').forEach(lab => {lab.addEventListener('blur', ()=>{lab.parentNode.parentNode.parentNode.className="";if (lab.innerText.trim() == "") lab.parentNode.parentNode.parentNode.remove()})})
	//document.querySelectorAll('#mg div').forEach(d => {d.addEventListener("mousedown", () => {let temp = document.querySelector('.temp'); if(temp) document.querySelectorAll('.temp .show').forEach(h => h.className="hide"), temp.className=""; d.parentNode.parentNode.className="temp"; let hide = document.querySelectorAll(".temp .hide"); hide.forEach(h => h.className="show"); drag = true})})
	
	let iclist = [], iclink = [];
	iclist.forEach((i, j) => {pushStyle(i, j)})
	function pushStyle(i, j){
		let style = document.createElement("style");
		style.innerHTML = `
			.${i}-task {
				background-image: url('${iclink[j]}');
			}
		`;
		document.head.appendChild(style);
	}
	
	
	if (localStorage.getItem("marks")) sd = JSON.parse(localStorage.getItem("marks")).sd, loadmarks(dd);
	window.addEventListener("message", (event) => {
		if (event.data.from === "listviewdrop") {
			iclist=event.data.n; iclink=event.data.f; iclist.forEach((i, j) => {pushStyle(i, j)}); loadmarks(dd); console.log("loaded", event.data.n, event.data.f)
		}
	});
	function loadmarks(e){ markgroup.innerHTML = ""; sd[e].forEach(e => loaddata(e)) }
	
	function updateProgress(){
		let time = new Date();
		timeProgress.style.width = (((time.getHours() * 60) + time.getMinutes()) - 240)/12 + 1 + "%";
	}
	updateProgress(); document.addEventListener("visibilitychange", () => updateProgress());
	timeContainer.addEventListener("dblclick", (e) => {
		if (e.target == timeContainer || e.target == timeProgress){
			const timeProgress = document.getElementById("progress");
			const time = (((e.clientX - rect.left)/rect.width*100)*12)+240, hour = Math.floor(time/60), minute = Math.floor(Math.floor(time%60)/5)*5;
			markgroup.innerHTML += `
			<marks class="" style="left: ${e.clientX - rect.left}px; width: 100px">
				<markrange class="hide"></markrange>
				<point>
					<line></line>
					<div>
						<button>${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}</button>
						<label contenteditable="true"></label>
					</div>
				</point>
				<endpoint class="hide">
					<div class="ep">${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}</div>
					<line></line>
				</endpoint>
			</marks>
			`;
			document.querySelectorAll('#mg point div label').forEach(lab => {lab.addEventListener('blur', ()=>{lab.parentNode.parentNode.parentNode.className="";if (lab.innerText.trim() == "") {lab.parentNode.parentNode.parentNode.remove(); sd[dd+de] = savedata(); localStorage.setItem("marks", JSON.stringify({ sd }))}; for (let i = 0; i<iclist.length; i++){if(lab.innerText.split('\n')[0].trim() == iclist[i]){lab.className=`task ${iclist[i]}-task`; lab.addEventListener("focus", ()=>{lab.className=""})}}})})
			document.querySelectorAll('#mg div').forEach(d => {d.addEventListener("mousedown", () => {let temp = document.querySelector('.temp'); if(temp) document.querySelectorAll('.temp .show').forEach(h => h.className="hide"), temp.className=""; d.parentNode.parentNode.className="temp"; let hide = document.querySelectorAll(".temp .hide"); hide.forEach(h => h.className="show"); drag = true})})
		}
	})
	document.addEventListener("mousedown", function(e) {let temp = document.querySelector('.temp'); ep = false; if(e.target.closest('.ep')) ep = true;if (temp!=null) {if(!e.target.closest('.temp div')){document.querySelectorAll('.temp .show').forEach(h => h.className="hide"); sd[dd+de] = savedata(); localStorage.setItem("marks", JSON.stringify({ sd })); temp.className=""}}});
	document.addEventListener("mouseup", () => drag = false)
	document.addEventListener("wheel", function(e) {e.preventDefault(); let temp = document.querySelector('.temp'); if (temp) {let line = document.querySelector('.temp point line'); let h = parseInt(window.getComputedStyle(line).height); h += e.deltaY > 0 ? 10 : -10; if (h < 32) h = 33; if (h > 260) h = 260; line.style.height = h + "px";}}, { passive: false });
	function savedata(){let data = [];
		const marks = document.querySelectorAll("marks");
		marks.forEach(mark => {
			const st = mark.querySelector('div button').innerHTML;
			const et = mark.querySelector('.ep').innerHTML;
			const h = parseInt(window.getComputedStyle(mark.querySelector('line')).height);
			let tst = mark.querySelector('label').innerHTML.split("<br>"); tst = tst.filter(item => item !== "");
			data.push([st, et, h, ...tst])
		})
		return data;
	}
	function margeText(e){ let marge = "";
		for (let i = 3; i < e.length; i++) {
			marge += e[i] + "<br>";
		}
		return marge;
	}
	
	function loaddata(e) {
		let time = Number(e[0].split(":")[0])*60 + Number(e[0].split(":")[1]), time2 = Number(e[1].split(":")[0])*60 + Number(e[1].split(":")[1]), icon = null;
		for (let i = 0; i<iclist.length; i++){if(e[3] == iclist[i]){icon=`task ${iclist[i]}-task`}}
		markgroup.innerHTML += `
		<marks class="" style="left: ${((time - 240)/1200)*rect.width}px; width: ${((time2-time)/1200)*rect.width}px">
			<markrange class="hide"></markrange>
			<point>
				<line style="height: ${e[2]}px"></line>
				<div>
					<button>${e[0]}</button>
					<label contenteditable="true" class="${icon}">${margeText(e)}</label>
				</div>
			</point>
			<endpoint class="hide">
				<div class="ep">${e[1]}</div>
				<line></line>
			</endpoint>
		</marks>
		`;
		document.querySelectorAll('#mg point div label').forEach(lab => {lab.addEventListener('blur', ()=>{lab.parentNode.parentNode.parentNode.className="";if (lab.innerText.trim() == "") {lab.parentNode.parentNode.parentNode.remove(); sd[dd+de] = savedata(); localStorage.setItem("marks", JSON.stringify({ sd }))}; for (let i = 0; i<iclist.length; i++){if(lab.innerText.split('\n')[0].trim() == iclist[i]){lab.className=`task ${iclist[i]}-task`; lab.addEventListener("focus", ()=>{lab.className=""})}}})})
		document.querySelectorAll('#mg div').forEach(d => {d.addEventListener("mousedown", () => {d.parentNode.parentNode.className="temp"; let hide = document.querySelectorAll(".temp .hide"); hide.forEach(h => h.className="show"); drag = true})})
	}
	let x1 = 0, x2 = 0;
	document.addEventListener("mousemove", (e) => {
		if(e.target.className == "ep"){
			x1 = e.pageX;
			const rect = timeContainer.getBoundingClientRect(), temp = document.querySelector('.temp');
			if (drag && x2 != null && temp){
				temp.style.width = parseInt(temp.style.width) + x1 - x2 + "px";
				let time = (((parseInt(temp.style.left) + parseInt(temp.style.width))/rect.width*100)*12)+240, hour = Math.floor(time/60), minute = Math.floor(Math.floor(time%60)/5)*5, lab = document.querySelector(".temp point button");
				e.target.innerHTML = `${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}`
			}
			x2 = e.pageX;
		} else {x1 = e.pageX;
			const rect = timeContainer.getBoundingClientRect(), temp = document.querySelector('.temp');
			if (drag && x2 != null && temp){
				temp.style.left = parseInt(temp.style.left) + x1 - x2 + "px";
				let time = ((parseInt(temp.style.left)/rect.width*100)*12)+240, hour = Math.floor(time/60), minute = Math.floor(Math.floor(time%60)/5)*5, lab = document.querySelector(".temp point button");
				lab.innerHTML = `${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}`;
				time = (((e.clientX - rect.left + parseInt(temp.style.width))/rect.width*100)*12)+240, hour = Math.floor(time/60), minute = Math.floor(Math.floor(time%60)/5)*5;
				document.querySelector('.temp endpoint div').innerHTML = `${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}`
			}
			x2 = e.pageX;
		}
	});
	const weatherLabel = document.getElementById('weather');
	async function loadWeather() {
	  // Example: Dhaka
	  const lat = 23.8103;
	  const lon = 90.4125;

	  // Fetch current weather + hourly humidity + apparent temperature
	  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relativehumidity_2m,apparent_temperature`;
	  const res = await fetch(url);
	  const data = await res.json();

	  // Current weather
	  const temp = data.current_weather.temperature;
	  const wind = data.current_weather.windspeed;
	  const code = data.current_weather.weathercode;
		const utcHour = now.getUTCHours();
		const dayIndex = 0;
		const hourIndex = dayIndex * 24 + utcHour;

		const humidity = data.hourly.relativehumidity_2m[hourIndex];
		const feelsLike = data.hourly.apparent_temperature[hourIndex];


	  // Map weather code to description
	  const conditions = {
		0: "Clear sky ☀️",
		1: "Mainly clear 🌤",
		2: "Partly cloudy ⛅",
		3: "Overcast ☁️",
		45: "Fog 🌫", 48: "Rime fog 🌫",
		51: "Light drizzle 🌦", 53: "Moderate drizzle 🌦", 55: "Dense drizzle 🌧",
		56: "Light freezing drizzle ❄️", 57: "Dense freezing drizzle ❄️",
		61: "Slight rain 🌧", 63: "Moderate rain 🌧", 65: "Heavy rain 🌧",
		66: "Light freezing rain ❄️", 67: "Heavy freezing rain ❄️",
		71: "Slight snowfall ❄️", 73: "Moderate snowfall ❄️", 75: "Heavy snowfall ❄️",
		77: "Snow grains ❄️",
		80: "Slight rain shower 🌦", 81: "Moderate rain shower 🌦", 82: "Violent rain shower 🌧",
		85: "Slight snow shower ❄️", 86: "Heavy snow shower ❄️",
		95: "Thunderstorm ⛈", 96: "Thunderstorm w/ slight hail ⛈", 99: "Thunderstorm w/ heavy hail ⛈"
	  };

	  const condition = conditions[code] || `Unknown (${code})`;
	  weatherLabel.innerText = `[ ${dd+de} ]: Today Weather Condition is ${condition} ${temp}°C , ${wind} km/h wind , ${humidity}% humidity Feels like ${feelsLike}°C`;
	}
	loadWeather();
	document.addEventListener("keydown", (e)=>{
		if (e.key == "ArrowRight"){
			const temp = markgroup.querySelector('.temp');
			if (temp) {const rect = timeContainer.getBoundingClientRect(), epp = temp.querySelector('.ep');
				if(ep){
					temp.style.width = parseInt(temp.style.width) + 1 + "px";
					let time = (((parseInt(temp.style.left) + parseInt(temp.style.width))/rect.width*100)*12)+240, hour = Math.floor(time/60), minute = Math.floor(time%60), lab = temp.querySelector("point button");
					epp.innerHTML = `${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}`;
				} else {
					temp.style.left = parseInt(temp.style.left) + 1 + "px";
					let time = ((parseInt(temp.style.left)/rect.width*100)*12)+240, hour = Math.floor(time/60), minute = Math.floor(time%60), lab = temp.querySelector("point button");
					lab.innerHTML = `${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}`;
					time = (((parseInt(temp.style.left) + parseInt(temp.style.width))/rect.width*100)*12)+240, hour = Math.floor(time/60), minute = Math.floor(time%60);
					epp.innerHTML = `${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}`
				}
			} else {de++; loadmarks(dd+de), weatherLabel.innerText = `[ ${dd+de} ]:${weatherLabel.innerText.split(":")[1]}`}
		}
		if (e.key == "ArrowLeft"){
			const temp = markgroup.querySelector('.temp');
			if (temp) {const rect = timeContainer.getBoundingClientRect(), epp = temp.querySelector('.ep');
				if(ep){
					temp.style.width = parseInt(temp.style.width) - 1 + "px";
					let time = (((parseInt(temp.style.left) + parseInt(temp.style.width))/rect.width*100)*12)+240, hour = Math.floor(time/60), minute = Math.floor(time%60), lab = temp.querySelector("point button");
					epp.innerHTML = `${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}`
				} else {
					temp.style.left = parseInt(temp.style.left) - 1 + "px";
					let time = ((parseInt(temp.style.left)/rect.width*100)*12)+240, hour = Math.floor(time/60), minute = Math.floor(time%60), lab = temp.querySelector("point button");
					lab.innerHTML = `${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}`;
					time = (((parseInt(temp.style.left) + parseInt(temp.style.width))/rect.width*100)*12)+240, hour = Math.floor(time/60), minute = Math.floor(time%60);
					epp.innerHTML = `${String(hour).padStart(2, "0")}:${String(minute).padStart(2, "0")}`
				}
			} else {de--; loadmarks(dd+de), weatherLabel.innerText = `[ ${dd+de} ]:${weatherLabel.innerText.split(":")[1]}`}
		}
	})
</script>
